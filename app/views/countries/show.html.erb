<div id="countryView">
  <div id="user" data-bounds="<%=@country.bounds%>" data-country="<%=@country%>"></div>

  <div class="mapStuff">
    <p id="notice"><%= notice %></p>
    <h2 id="countryName"><%= @country.name %></h2>
    <div class="details">
      <p class="lat"></p>
      <p class="lon"></p>
      <h2>Add a visited region on map click!</h2>
      <h3>Add details below:</h3><br>
      <div class="deet-field">
        <label>Radius of visited area (km):</label>
        <input type=text class="rad"><br>
      </div>
      <div class="deet-field">
        <label>Region note:</label>
        <input type=text class="popupNote"><br>
      </div>
    </div>
  </div>
  <div id="countryMap"></div>
  <div class="blogs">
    <h2>New Blog Post For <%=@country.name%>:</h2>
    <p id="notice"><%= notice %></p>
    <div class="deet-field blog">
      <label>Blog Title:</label>
      <input type=text class="blog-title">

    </div>
    <div class="deet-field blog">
      <label>Blog Post:</label>
      <textarea class="blog-content"></textarea>
      <p class="save"><i class="far fa-save"></i></p>
    </div>

    <h2>Previous Blog Posts From <%=@country.name%>:</h2>
  <% @blogs.each do |blog| %>
    <div class="blog">
      <h3><%=blog.title%></h3>
      <p> <%= blog.created_at.strftime("%d %B %Y:") %> </p>
      <p><%=blog.post%><p>
    </div>
  <%end%>
</div>

  <div id="gallery">
    <div class="gallery-data">
      <%= form_for([@country.user, @country]) do |f| %>
        <% if @country.errors.any? %>
          <div id="error_explanation">
            <h2><%= pluralize(@country.errors.count, "error") %> prohibited this image from being saved:</h2>
            <ul>
              <% @country.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
        <h2>Select files to add to your <%= @country.name %> gallery:</h2>
        <div class="field">
            <%= f.file_field :images, multiple: true %>
        </div>

        <div class="actions">
          <%= f.submit "Add images", class:"btn form-btn" %>
        </div>
      <% end %>
      </div>
    <% @country.images.each do |pic| %>
      <%= image_tag(pic.url, :class => "country-images") %>
    <% end %>
  </div>
</div>



<script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
<script type="text/javascript">
  let lat = document.querySelector('.lat');
  let lon = document.querySelector('.lon');
  let rad = document.querySelector('.rad');
  let circle = undefined;
  let popupNote = document.querySelector('.popupNote')
  let user =$('#user').data().bounds
  let coords = user.split(',');
  console.log(coords[0]);
  console.log(coords[1]);

  let addCircle = function (event) {
    circle = L.circle(event.latlng, {
    color: 'red',
    fillColor: '#f03',
    fillOpacity: 0.5,
    radius: rad.value*1609.34,
    stroke: false
    }).addTo(mymap);
    circle.bindPopup(popupNote.value);
  }
  let mymap = L.map('countryMap', {
      minZoom: 1,
      noWrap: true
  }).setView([coords[0],coords[1]], 0);
  let layer = new L.StamenTileLayer("toner",{
    noWrap: true
  }).addTo(mymap);
  function onMapClick(event) {
    lat.innerHTML = event.latlng.lat;
    lon.innerHTML = event.latlng.lng;
    addCircle(event);
    alert("Added visited region");
  }
  function saveBlog(event){
    let token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    let data = $('#user').data()
    let uri = "<%=request.fullpath%>"
    let blog = {
      title: document.querySelector('.blog-title').value,
      post: document.querySelector('.blog-content').value,
      country: data.country
    }
    fetch(`${uri}/blogs.json`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': token,
      },
      body: JSON.stringify(blog)
    })

  }
  mymap.addEventListener('click', onMapClick);
  let faSave = document.querySelector('i');
  faSave.addEventListener('click', saveBlog);
</script>
